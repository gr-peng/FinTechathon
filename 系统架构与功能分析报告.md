# 本地 AI 记账助手系统 - 架构与功能分析报告

## 一、系统架构设计

### 1.1 整体架构

系统采用**前后端分离**的架构设计，基于 RESTful API 进行通信。

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Frontend)                      │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │账单录入  │ │交易列表  │ │财务报告  │ │财务建议  │      │
│  │(HTML)    │ │(HTML)    │ │(HTML)    │ │(HTML)    │      │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
│                                                              │
│  技术栈: HTML5 + Tailwind CSS + JavaScript (原生)           │
└───────────────────────┬─────────────────────────────────────┘
                        │ HTTP/REST API
┌───────────────────────┴─────────────────────────────────────┐
│                     后端服务层 (Backend)                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              FastAPI Web 框架                         │  │
│  │  - RESTful API 接口                                   │  │
│  │  - CORS 跨域支持                                      │  │
│  │  - 请求验证与错误处理                                 │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │            AI 模型服务层                               │  │
│  │  - Qwen2.5-VL-3B-Instruct (多模态视觉语言模型)        │  │
│  │  - Qwen3-4B (纯文本语言模型)                          │  │
│  │  - Transformers 库加载与推理                          │  │
│  │  - 支持 CUDA GPU 加速                                 │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │           数据处理与存储层                             │  │
│  │  - SQLite 数据库 (bills.db)                           │  │
│  │  - JSONL 数据文件 (synthetic_bank_bills.jsonl)        │  │
│  │  - 线程安全的数据库操作                               │  │
│  └──────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈详情

#### 后端技术栈
- **Web 框架**: FastAPI 0.115.0
- **ASGI 服务器**: Uvicorn 0.30.6
- **AI 模型框架**: Transformers >= 4.47.0
- **深度学习框架**: PyTorch >= 2.1.0
- **加速库**: Accelerate >= 0.33.0
- **图像处理**: Pillow >= 10.0.0
- **数据库**: SQLite3 (Python 内置)
- **数据验证**: Pydantic

#### 前端技术栈
- **UI 框架**: Tailwind CSS (CDN)
- **字体**: Noto Sans SC (中文字体) + Manrope (英文字体)
- **图标**: Material Symbols Outlined
- **通信方式**: Fetch API (原生 JavaScript)

### 1.3 核心模块设计

#### 1.3.1 模型加载模块 (`load_model_if_needed()`)
- **功能**: 延迟加载 AI 模型，支持首次请求时自动加载
- **特性**:
  - 自动检测模型类型（多模态 vs 纯文本）
  - 支持模型目录自动解析（根目录或 `model/` 子目录）
  - 根据硬件自动选择设备（CUDA GPU 或 CPU）
  - 使用 `bfloat16` 精度（GPU）或 `float32` 精度（CPU）
  - 支持 `device_map="auto"` 自动设备映射

#### 1.3.2 数据库管理模块
- **表结构**:
  ```sql
  CREATE TABLE bills (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      event_date TEXT NOT NULL,        -- 账单日期 (ISO 格式)
      category TEXT NOT NULL,          -- 类别 (餐饮/出行/购物等)
      type TEXT NOT NULL,              -- 类型 (expense/income)
      amount REAL NOT NULL,            -- 金额
      currency TEXT NOT NULL,          -- 币种 (默认 CNY)
      description TEXT NOT NULL,       -- 描述
      source TEXT,                     -- 数据来源 (ocr/manual/jsonl)
      metadata TEXT,                   -- 元数据 (JSON 格式)
      created_at TEXT NOT NULL         -- 创建时间
  )
  ```
- **线程安全**: 使用 `threading.Lock` 确保并发安全
- **数据导入**: 支持从 JSONL 文件自动导入初始数据

#### 1.3.3 上下文构建模块
- **账单上下文** (`build_bill_context()`): 提取最新 20 条账单作为上下文
- **检索增强上下文** (`build_retrieval_context()`): 基于全库构建 RAG 上下文
  - 全局总览（总收入/支出）
  - 按类别汇总（收入/支出）
  - 按月汇总（可限制最近 N 个月）
  - Top 商户统计（支出 Top 10）

#### 1.3.4 报告生成模块
- **周报** (`_build_week_report()`): 按天聚合本周数据
- **月报** (`_build_month_report()`): 按周聚合本月数据
- **年报** (`_build_year_report()`): 按月聚合本年数据
- **自定义报表** (`_build_custom_report()`): 根据时间跨度自动选择聚合粒度
  - ≤31 天: 按天聚合
  - ≤180 天: 按周聚合
  - >180 天: 按月聚合

### 1.4 数据流设计

#### 账单录入流程
```
用户输入 (文本/图片)
    ↓
前端发送 POST /chat
    ↓
AI 模型解析 (JSON 格式)
    ↓
前端提取 JSON 数据
    ↓
前端发送 POST /bills
    ↓
后端验证并写入 SQLite
    ↓
返回成功响应
```

#### 财务分析流程
```
用户查询请求
    ↓
前端调用 GET /advice/context
    ↓
后端查询数据库
    ↓
统计分析 (30天/90天/180天)
    ↓
返回结构化数据
    ↓
前端调用 POST /chat (带上下文)
    ↓
AI 生成分析报告
    ↓
返回给用户
```

## 二、可以实现的功能

### 2.1 账单管理功能

#### 2.1.1 账单录入
- **文本录入**: 用户输入自然语言描述，AI 自动解析为结构化账单
  - 示例: "今天在星巴克消费了45元"
  - 输出: JSON 格式的账单数据（日期、类别、金额、描述等）
- **图片 OCR**: 上传票据图片，使用多模态模型识别并提取账单信息
  - 支持格式: JPEG, PNG 等常见图片格式
  - 识别字段: 日期、金额、类别、商户名称、支付方式
  - 自动转换为 JSON 格式
- **手动录入**: 直接通过 API 提交结构化账单数据

#### 2.1.2 账单查询
- **基础查询**: 
  - 按类别筛选（餐饮、出行、购物、生活缴费、娱乐、其他）
  - 按类型筛选（收入/支出）
  - 按时间范围筛选（开始日期、结束日期）
  - 分页支持（limit 参数，最大 500 条）
- **账单汇总**: 
  - 总收入/总支出统计
  - 按类别汇总（收入/支出）
  - 按时间维度汇总

#### 2.1.3 账单删除
- 支持通过账单 ID 删除指定账单
- 包含存在性验证和错误处理

### 2.2 AI 聊天助手功能

#### 2.2.1 智能对话
- **上下文感知**: 自动注入最新 20 条账单或全库检索上下文
- **多轮对话**: 支持多轮对话历史
- **自定义提示词**: 支持覆盖默认系统提示词
- **参数可调**: 
  - `max_new_tokens`: 最大生成 token 数（默认 3000，上限 4096）
  - `temperature`: 采样温度（默认 0.7）
  - `top_p`: 核采样参数（默认 0.9）
  - `repetition_penalty`: 重复惩罚（默认 1.05）

#### 2.2.2 检索增强生成 (RAG)
- **全库检索**: 基于整个数据库构建上下文
  - 全局统计（总收入/支出）
  - 类别汇总
  - 月度趋势
  - Top 商户分析
- **时间窗口控制**: 可限制检索最近 N 个月的数据（默认 12 个月）
- **开关控制**: 可通过环境变量或请求参数控制是否启用 RAG

#### 2.2.3 输出优化
- **CoT 抑制**: 自动去除模型输出的思考过程标签（`<think>`）
- **JSON 格式验证**: 确保结构化输出符合 JSON 规范
- **中文优化**: 系统提示词强制使用简体中文

### 2.3 财务报告功能

#### 2.3.1 多维度报表
- **周报**: 
  - 按天展示本周收入/支出柱状图
  - 与上周对比（净储蓄、类别变化）
  - 支出占比饼图
- **月报**: 
  - 按周展示本月收入/支出柱状图
  - 与上月对比
  - 类别对比和占比分析
- **年报**: 
  - 按月展示本年收入/支出柱状图
  - 与去年对比
  - 全年趋势分析

#### 2.3.2 自定义报表
- 支持自定义时间范围查询
- 自动选择聚合粒度（日/周/月）
- 与同期对比分析

#### 2.3.3 数据来源
- **主要数据源**: `synthetic_bank_bills.jsonl`（过去一年的合成数据）
- **实时数据源**: SQLite 数据库（用户录入的真实数据）
- 数据缓存: 使用 `@lru_cache` 缓存报表数据

### 2.4 财务建议功能

#### 2.4.1 财务概览 (Overview)
- **时间范围**: 最近 30 天
- **分析内容**:
  - 收入/支出/净储蓄统计
  - 与上期对比（收入、支出、净储蓄变化）
  - 类别变化分析（Top 6 类别，按变化幅度排序）
  - 大额交易识别（Top 5 支出交易）

#### 2.4.2 消费行为分析 (Behavior)
- **时间范围**: 过去 180 天
- **分析内容**:
  - 月度收支统计（6 个月趋势）
  - 类别消费模式分析
    - 平均值计算
    - 波动性分析（标准差）
    - 趋势判断（上升/下降/稳定）
  - 风险标志识别
    - 波动性超过平均值 50% 的类别
    - 自动标记为"波动显著，建议监控"

#### 2.4.3 财务建议中心 (Advice)
- **时间范围**: 最近 90 天
- **分析内容**:
  - 储蓄率计算: `(收入 - 支出) / 收入`
  - 支出结构分析（类别占比）
  - 固定支出识别（占比 ≥15% 的类别）
  - 压力点识别（占比 >30% 的类别）

### 2.5 前端页面功能

#### 2.5.1 账单自动扫描录入 (`bill_auto-scan`)
- 三种录入方式:
  1. 文本描述录入
  2. 图片 OCR 录入
  3. 手动表单录入
- 自动调用 `/chat` 接口解析
- 自动调用 `/bills` 接口入库

#### 2.5.2 交易列表 (`transaction_list`)
- 加载 `/bills` 和 `/bills/summary` 数据
- 支持搜索和筛选
- AI 总结功能（调用 `/chat` 接口）

#### 2.5.3 财务可视化 (`visualization`)
- 使用 `/reports/aggregate` 接口
- 渲染周/月/年财务报告
- 柱状图、饼图、对比图表
- 储蓄目标设置

#### 2.5.4 财务顾问 (`financial_advice`)
- 使用 `/advice/context` 获取数据
- 调用 `/chat` 生成 AI 总览
- 生成行为分析报告
- 生成财务建议

#### 2.5.5 欢迎与设置 (`welcome`)
- 聊天页面默认自动带入账单上下文
- 后端服务地址配置（localStorage）

## 三、算法和模型选型

### 3.1 AI 模型选型

#### 3.1.1 主要模型: Qwen2.5-VL-3B-Instruct
- **模型类型**: 多模态视觉语言模型 (Vision-Language Model)
- **参数量**: 3B (30 亿参数)
- **能力**:
  - 文本理解与生成
  - 图像理解与 OCR
  - 多模态融合推理
- **应用场景**:
  - 票据图片识别
  - 自然语言账单解析
  - 财务问答与建议生成
- **技术细节**:
  - 使用 `AutoModelForVision2Seq` 加载
  - 支持 `AutoProcessor` 处理图像和文本
  - 使用 `apply_chat_template` 构建对话格式
  - 支持 `process_vision_info` 处理视觉信息

#### 3.1.2 备选模型: Qwen3-4B
- **模型类型**: 纯文本语言模型 (Causal Language Model)
- **参数量**: 4B (40 亿参数)
- **能力**:
  - 文本理解与生成
  - 结构化数据提取
  - 对话生成
- **应用场景**:
  - 纯文本账单解析
  - 财务问答
  - 报告生成
- **技术细节**:
  - 使用 `AutoModelForCausalLM` 加载
  - 使用 `AutoTokenizer` 进行文本编码
  - 支持 `apply_chat_template` 对话模板

#### 3.1.3 模型加载策略
- **延迟加载**: 首次请求时加载，避免启动时内存占用
- **设备选择**: 
  - 优先使用 CUDA GPU（`torch.cuda.is_available()`）
  - 回退到 CPU
- **精度选择**:
  - GPU: `bfloat16`（平衡精度与性能）
  - CPU: `float32`（保证精度）
- **设备映射**: 使用 `device_map="auto"` 自动分配多 GPU

### 3.2 生成算法参数

#### 3.2.1 文本生成参数
```python
{
    "max_new_tokens": 3000,        # 默认最大生成 token 数
    "min_new_tokens": None,        # 最小生成 token 数（可选）
    "temperature": 0.7,            # 采样温度（0-1，越高越随机）
    "top_p": 0.9,                  # 核采样（保留概率质量前 90%）
    "repetition_penalty": 1.05,    # 重复惩罚（>1 减少重复）
    "do_sample": True,             # 启用采样（temperature > 0 时）
    "pad_token_id": eos_token_id,  # 填充 token
    "eos_token_id": eos_token_id   # 结束 token
}
```

#### 3.2.2 参数限制策略
- **最大 token 上限**: 4096（通过环境变量 `AI_BOOKKEEPER_MAX_NEW_TOKENS_CAP` 配置）
- **默认 token 数**: 1024（通过环境变量 `AI_BOOKKEEPER_DEFAULT_MAX_NEW_TOKENS` 配置）
- **最小 token 下限**: 32（硬编码）

### 3.3 数据处理算法

#### 3.3.1 类别归一化算法
- **别名映射**: 使用 `CATEGORY_ALIASES` 字典进行类别标准化
  ```python
  CATEGORY_ALIASES = {
      "餐": "餐饮", "饭": "餐饮", "外卖": "餐饮",
      "交通": "出行", "打车": "出行",
      "数码": "购物",
      "话费": "生活缴费", "水电": "生活缴费",
      "影视": "娱乐", "游戏": "娱乐"
  }
  ```
- **默认类别**: 未匹配的类别统一归为"其他"
- **标准类别**: 餐饮、出行、购物、生活缴费、娱乐、其他

#### 3.3.2 时间聚合算法
- **周聚合**: 
  - 计算周一起始日期: `ref_date - timedelta(days=ref_date.weekday())`
  - 按天聚合 7 天数据
- **月聚合**: 
  - 计算月初: `ref_date.replace(day=1)`
  - 按周聚合（跨周处理）
- **年聚合**: 
  - 计算年初: `date(ref_date.year, 1, 1)`
  - 按月聚合 12 个月数据
- **自定义聚合**: 
  - 根据时间跨度自动选择粒度
  - 使用 `_shift_month()` 处理月份边界

#### 3.3.3 统计分析算法
- **趋势分析**:
  ```python
  if series[-1] > (series[0] * 1.15):
      trend = "up"      # 上升（增长 >15%）
  elif series[-1] < (series[0] * 0.85):
      trend = "down"    # 下降（减少 >15%）
  else:
      trend = "stable"  # 稳定
  ```
- **波动性分析**:
  ```python
  avg = statistics.mean(series)           # 平均值
  std = statistics.pstdev(series)         # 总体标准差
  if std > avg * 0.5:
      risk_flag = "波动显著"              # 标准差 > 平均值 50%
  ```
- **占比计算**:
  ```python
  share = (category_amount / total_expense)  # 类别占比
  if share > 0.3:
      pressure_point = True                  # 压力点（占比 >30%）
  if share >= 0.15:
      fixed_candidate = True                 # 固定支出（占比 ≥15%）
  ```

### 3.4 检索增强生成 (RAG) 算法

#### 3.4.1 上下文构建策略
- **全局统计**: SQL 聚合查询
  ```sql
  SELECT 
      SUM(CASE WHEN type='income' THEN amount ELSE 0 END) AS total_income,
      SUM(CASE WHEN type='expense' THEN amount ELSE 0 END) AS total_expense
  FROM bills
  ```
- **类别汇总**: GROUP BY 查询
  ```sql
  SELECT category, type, SUM(amount) AS total
  FROM bills
  GROUP BY category, type
  ORDER BY total DESC
  ```
- **月度汇总**: 时间函数聚合
  ```sql
  SELECT strftime('%Y-%m', date(event_date)) AS ym, 
         type, SUM(amount) AS total
  FROM bills
  GROUP BY ym, type
  ORDER BY ym DESC
  ```
- **Top 商户**: JSON 提取 + 聚合
  ```sql
  SELECT 
      COALESCE(
          json_extract(metadata, '$.merchant'),
          json_extract(metadata, '$.raw.商户'),
          '未知商户'
      ) AS merchant,
      SUM(CASE WHEN type='expense' THEN amount ELSE 0 END) AS expense_total
  FROM bills
  GROUP BY merchant
  ORDER BY expense_total DESC
  LIMIT 10
  ```

#### 3.4.2 时间窗口控制
- **默认窗口**: 最近 12 个月
- **可配置**: 通过 `retrieval_months` 参数控制
- **无限制模式**: `retrieval_months=None` 时检索全部数据

### 3.5 数据生成算法 (合成数据)

#### 3.5.1 类别分布算法
- **权重分布**: 使用 `random.choices()` 按权重随机选择
  ```python
  CATEGORY_DISTRIBUTION = {
      "餐饮": 0.35,      # 35%
      "出行": 0.10,      # 10%
      "购物": 0.25,      # 25%
      "生活缴费": 0.10,  # 10%
      "娱乐": 0.15,      # 15%
      "其他": 0.05       # 5%
  }
  ```

#### 3.5.2 金额生成算法
- **范围随机**: 使用 `random.uniform(low, high)` 生成
- **类别特定范围**:
  ```python
  EXPENSE_AMOUNT_RANGE = {
      "餐饮": (20, 150),
      "出行": (3, 300),
      "购物": (20, 2000),
      "生活缴费": (50, 600),
      "娱乐": (10, 800),
      "其他": (5, 200)
  }
  ```

#### 3.5.3 时间分布算法
- **均匀分布**: 过去 365 天内随机分布
- **月度权重**: 不同月份有不同的消费频率权重
  ```python
  MONTH_EXPENSE_WEIGHTS = {
      1: 0.9, 2: 0.8, 3: 1.0, 4: 1.1, 5: 1.0, 6: 1.1,
      7: 0.9, 8: 0.8, 9: 1.2, 10: 1.3, 11: 1.1, 12: 1.4
  }
  ```

### 3.6 性能优化策略

#### 3.6.1 缓存机制
- **报表缓存**: 使用 `@lru_cache(maxsize=1)` 缓存报表数据
- **模型单例**: 全局变量存储模型实例，避免重复加载

#### 3.6.2 数据库优化
- **索引**: 在 `event_date` 字段上使用日期函数索引
- **批量操作**: 使用 `executemany()` 批量插入数据
- **连接复用**: 使用全局数据库连接，避免频繁创建连接

#### 3.6.3 内存管理
- **延迟加载**: 模型首次使用时加载
- **精度优化**: GPU 使用 `bfloat16` 减少内存占用
- **设备映射**: 多 GPU 环境下自动分配模型层

## 四、系统特色与创新点

### 4.1 本地化部署
- **数据隐私**: 所有数据存储在本地 SQLite 数据库
- **模型本地化**: AI 模型完全本地运行，无需联网
- **离线可用**: 支持完全离线环境运行

### 4.2 多模态支持
- **文本 + 图像**: 支持文本描述和图片 OCR 两种录入方式
- **统一接口**: 通过同一套 API 处理不同模态的输入
- **自动降级**: 非视觉模型自动降级到文本处理

### 4.3 智能上下文管理
- **双模式检索**: 
  - 快速模式: 最新 20 条账单
  - 深度模式: 全库 RAG 检索
- **时间窗口控制**: 可限制检索时间范围，平衡性能与准确性
- **动态上下文**: 根据查询类型自动选择上下文策略

### 4.4 灵活的报表系统
- **多维度分析**: 支持周/月/年/自定义时间范围
- **自动聚合**: 根据时间跨度自动选择聚合粒度
- **对比分析**: 自动与上一周期对比，识别变化趋势

### 4.5 智能财务分析
- **行为模式识别**: 自动识别消费趋势和波动性
- **风险预警**: 自动标记异常波动类别
- **建议生成**: 基于数据分析生成个性化财务建议

## 五、技术细节总结

### 5.1 关键技术点
1. **模型适配**: 自动检测模型类型（多模态 vs 纯文本）
2. **设备适配**: 自动选择 GPU/CPU，优化精度配置
3. **线程安全**: 使用锁机制保证数据库并发安全
4. **错误处理**: 完善的异常处理和降级策略
5. **数据验证**: 使用 Pydantic 进行请求数据验证

### 5.2 扩展性设计
- **环境变量配置**: 支持通过环境变量自定义模型路径、端口等
- **插件化架构**: 前端页面独立，易于扩展新功能
- **API 标准化**: RESTful API 设计，易于集成第三方系统

### 5.3 安全性考虑
- **输入验证**: 严格的参数验证和类型检查
- **SQL 注入防护**: 使用参数化查询
- **文件上传限制**: OCR 接口限制文件类型为图片
- **CORS 配置**: 支持跨域访问（生产环境建议限制）

## 六、总结

本系统是一个功能完整、架构清晰的本地 AI 记账助手，具有以下特点：

1. **技术先进**: 采用最新的多模态大语言模型，支持文本和图像理解
2. **功能全面**: 涵盖账单管理、财务分析、AI 助手、报表生成等完整功能
3. **架构合理**: 前后端分离，模块化设计，易于维护和扩展
4. **性能优化**: 缓存机制、延迟加载、设备适配等多重优化
5. **用户友好**: 自然语言交互，智能上下文理解，自动化程度高

系统适合个人或小型团队使用，特别注重数据隐私和本地化部署，是一个实用的财务管理工具。

