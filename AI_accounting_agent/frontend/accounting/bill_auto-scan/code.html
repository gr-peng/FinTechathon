<!DOCTYPE html>
<html lang="zh"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>交易记录</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            "primary": "#3B82F6", // Blue-500
            "primary-light": "#EFF6FF", // Blue-50
            "primary-dark": "#1E40AF", // Blue-800
            "background": "#F9FAFB", // Gray-50
            "text-primary": "#111827", // Gray-900
            "text-secondary": "#6B7280", // Gray-500
            "income": "#16A34A", // Green-600
            "expense": "#DC2626", // Red-600
            "border-color": "#E5E7EB" // Gray-200
          },
          fontFamily: {
            "display": ["Noto Sans SC", "Manrope", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "1rem",
            "lg": "2rem",
            "xl": "3rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
<style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24
    }
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="bg-background font-display text-text-primary">
<div class="relative mx-auto min-h-screen w-full max-w-lg flex-col overflow-x-hidden">
<header class="sticky top-0 z-10 bg-background/80 backdrop-blur-sm">
<div class="flex items-center p-4 pb-2 justify-between">
<div class="flex size-12 shrink-0 items-center justify-start">
<button class="flex items-center justify-center rounded-full h-10 w-10 text-text-secondary">
<span class="material-symbols-outlined text-2xl">account_balance</span>
</button>
</div>
<h1 class="text-text-primary text-lg font-bold">交易记录</h1>
<div class="flex w-12 items-center justify-end">
<button class="flex items-center justify-center rounded-full h-10 w-10 text-text-secondary">
<span class="material-symbols-outlined text-2xl">sync</span>
</button>
</div>
</div>
</header>
<main class="px-4 pb-32">
<div class="py-3">
<label class="flex flex-col min-w-40 h-12 w-full">
<div class="flex w-full flex-1 items-stretch rounded-full h-full">
<div class="text-text-secondary flex border-none bg-primary-light items-center justify-center pl-4 rounded-l-full border-r-0">
<span class="material-symbols-outlined">search</span>
</div>
<input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-r-full text-text-primary focus:outline-0 focus:ring-0 border-none bg-primary-light h-full placeholder:text-text-secondary px-4 text-base font-normal" placeholder="搜索交易..."/>
</div>
</label>
</div>
<div class="flex gap-2 py-3 overflow-x-auto">
<div class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-primary text-white px-4">
<p class="text-sm font-medium">全部</p>
</div>
<div class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white border border-border-color px-4">
<p class="text-text-primary text-sm font-medium">收入</p>
</div>
<div class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white border border-border-color px-4">
<p class="text-text-primary text-sm font-medium">支出</p>
</div>
<div class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white border border-border-color px-4">
<p class="text-text-primary text-sm font-medium">未分类</p>
</div>
</div>
<div class="space-y-4">
<h3 class="text-text-primary text-lg font-bold leading-tight pt-4">今天</h3>
<div class="flex items-center gap-4 min-h-[72px] py-2 justify-between">
<div class="flex items-center gap-4">
<div class="text-primary flex items-center justify-center rounded-lg bg-primary-light shrink-0 size-12">
<span class="material-symbols-outlined">work</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-text-primary text-base font-medium">Acme 公司</p>
<p class="text-text-secondary text-sm font-normal">薪水</p>
</div>
</div>
<div class="shrink-0">
<p class="text-income text-base font-medium">+¥16,800.00</p>
</div>
</div>
<div class="flex items-center gap-4 min-h-[72px] py-2 justify-between">
<div class="flex items-center gap-4">
<div class="text-primary flex items-center justify-center rounded-lg bg-primary-light shrink-0 size-12">
<span class="material-symbols-outlined">restaurant</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-text-primary text-base font-medium">街角咖啡馆</p>
<p class="text-text-secondary text-sm font-normal">餐饮</p>
</div>
</div>
<div class="shrink-0">
<p class="text-expense text-base font-medium">-¥88.50</p>
</div>
</div>
<div class="flex items-center gap-4 min-h-[72px] py-2 justify-between">
<div class="flex items-center gap-4">
<div class="text-primary flex items-center justify-center rounded-lg bg-primary-light shrink-0 size-12">
<span class="material-symbols-outlined">receipt_long</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-text-primary text-base font-medium">微信支付</p>
<div class="flex items-center gap-1">
<p class="text-text-secondary text-sm font-normal">待审核</p>
<span class="material-symbols-outlined text-text-secondary text-sm">help_outline</span>
</div>
</div>
</div>
<div class="shrink-0">
<p class="text-expense text-base font-medium">-¥200.00</p>
</div>
</div>
<h3 class="text-text-primary text-lg font-bold leading-tight pt-4">昨天</h3>
<div class="flex items-center gap-4 min-h-[72px] py-2 justify-between">
<div class="flex items-center gap-4">
<div class="text-primary flex items-center justify-center rounded-lg bg-primary-light shrink-0 size-12">
<span class="material-symbols-outlined">shopping_cart</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-text-primary text-base font-medium">网上商城</p>
<p class="text-text-secondary text-sm font-normal">购物</p>
</div>
</div>
<div class="shrink-0">
<p class="text-expense text-base font-medium">-¥359.90</p>
</div>
</div>
<div class="flex items-center gap-4 min-h-[72px] py-2 justify-between">
<div class="flex items-center gap-4">
<div class="text-primary flex items-center justify-center rounded-lg bg-primary-light shrink-0 size-12">
<span class="material-symbols-outlined">movie</span>
</div>
<div class="flex flex-col justify-center">
<p class="text-text-primary text-base font-medium">流媒体服务</p>
<p class="text-text-secondary text-sm font-normal">娱乐</p>
</div>
</div>
<div class="shrink-0">
<p class="text-expense text-base font-medium">-¥25.00</p>
</div>
</div>
</div>
</main>
<div class="fixed bottom-0 left-0 right-0 p-4 bg-background/80 backdrop-blur-sm border-t border-border-color flex justify-around items-center">
<button class="flex flex-col items-center gap-1 text-primary w-1/3">
<span class="material-symbols-outlined">add_circle</span>
<span class="text-sm font-medium">手动输入</span>
</button>
<button class="flex flex-col items-center gap-1 text-primary w-1/3">
<span class="material-symbols-outlined">photo_camera</span>
<span class="text-sm font-medium">上传票据</span>
</button>
<button class="flex flex-col items-center gap-1 text-primary w-1/3">
<span class="material-symbols-outlined">description</span>
<span class="text-sm font-medium">文本描述</span>
</button>
</div>
</div>
<script>
const API_KEY='AI_BOOKKEEPER_API';
const API_BASE=(window.LOCAL_LLM_API||localStorage.getItem(API_KEY)||'http://10.120.17.24:8010');

async function callChat(prompt){
	const res = await fetch(`${API_BASE}/chat`,{
		method:'POST',
		headers:{'Content-Type':'application/json'},
		body:JSON.stringify({
			messages:[{role:'user',content:prompt}],
			include_bill_context:false
		})
	});
	if(!res.ok) throw new Error(await res.text());
	return res.json();
}

function extractJson(text){
	if(!text) return null;
	let cleaned = text.trim();
	cleaned = cleaned.replace(/```json/gi,'').replace(/```/g,'').trim();
	const firstBrace = cleaned.indexOf('{');
	const lastBrace = cleaned.lastIndexOf('}');
	if(firstBrace === -1 || lastBrace === -1) return null;
	cleaned = cleaned.slice(firstBrace, lastBrace+1);
	try{ return JSON.parse(cleaned); }catch(e){ return null; }
}

function normalizeBill(obj, fallback){
	if(!obj || typeof obj!=='object') return null;
	const result = {};
	const mapKey = (keys)=>keys.find(k=>Object.prototype.hasOwnProperty.call(obj,k));
	const dateKey = mapKey(['event_date','日期','时间','date']);
	const categoryKey = mapKey(['category','类别','分类']);
	const amountKey = mapKey(['amount','金额','数额','money']);
	const typeKey = mapKey(['type','类型']);
	const currencyKey = mapKey(['currency','币种']);
	const descKey = mapKey(['description','摘要','说明','备注','detail']);
	result.event_date = (()=>{
		const raw = dateKey?obj[dateKey]:null;
		if(!raw) return (new Date()).toISOString().slice(0,10);
		if(typeof raw==='string'){
			const iso = raw.match(/\d{4}-\d{1,2}-\d{1,2}/);
			if(iso) return iso[0];
			const digits = raw.match(/\d+/g);
			if(digits && digits.length>=3){
				const [y,m,d]=digits;
				return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
			}
		}
		return (new Date()).toISOString().slice(0,10);
	})();
	result.category = categoryKey?String(obj[categoryKey]||'').trim():'其他';
	let amountRaw = amountKey?obj[amountKey]:null;
	if(typeof amountRaw === 'string') amountRaw = amountRaw.replace(/[^0-9.+-]/g,'');
	const parsedAmount = parseFloat(amountRaw || '0');
	result.amount = Number.isFinite(parsedAmount)?Math.abs(parsedAmount):0;
	const typeRaw = typeKey?String(obj[typeKey]||'').toLowerCase():'';
	result.type = typeRaw.includes('收')||typeRaw.includes('income')?'income':'expense';
	result.currency = currencyKey?String(obj[currencyKey]||'').trim().toUpperCase():'CNY';
	const descRaw = descKey?obj[descKey]:fallback;
	result.description = String(descRaw||fallback||'未命名').trim();
	return result;
}

async function saveBillToBackend(payload){
	const res = await fetch(`${API_BASE}/bills`,{
		method:'POST',
		headers:{'Content-Type':'application/json'},
		body:JSON.stringify(payload)
	});
	if(!res.ok){
		throw new Error(await res.text());
	}
	return res.json();
}

async function parseAndStoreBill(naturalText, source){
	const prompt = `请将以下记账描述解析为JSON，键包含 event_date(YYYY-MM-DD), category, type(expense/income), amount(数字), currency, description。仅输出JSON：${naturalText}`;
	const chatRes = await callChat(prompt);
	const obj = extractJson(chatRes.reply);
	const normalized = normalizeBill(obj, naturalText);
	if(!normalized || !normalized.amount){
		throw new Error('解析失败，未获取到金额');
	}
	normalized.source = source;
	normalized.metadata = { raw: naturalText };
	const saved = await saveBillToBackend(normalized);
	return { parsed: normalized, saved };
}

// 底部三个按钮：手动输入 / 上传票据 / 文本描述
(function(){
	const btns = document.querySelectorAll('.fixed button');
	if(btns.length<3) return;
	// 手动输入
	btns[0].addEventListener('click',async()=>{
		const text = prompt('请输入交易描述（例如：昨天午餐 25 元，餐饮）');
		if(!text) return;
		try{
			const {saved} = await parseAndStoreBill(text,'manual');
			alert(`已保存：${saved.category} ${saved.amount}${saved.currency} (${saved.event_date})`);
		}catch(e){ alert('保存失败：'+(e?.message||e)); }
	});
	// 上传票据（模拟OCR）
	btns[1].addEventListener('click',()=>{
		const input=document.createElement('input'); input.type='file'; input.accept='image/*';
		input.onchange=async()=>{
			const file=input.files?.[0]; if(!file) return;
			const fakeOcr=`票据OCR文本：文件 ${file.name}；项目：餐饮；金额：48元；时间：${new Date().toLocaleDateString('zh-CN')}。请按照要求输出JSON。`;
			try{
				const {saved} = await parseAndStoreBill(fakeOcr,'ocr');
				alert(`OCR已保存：${saved.category} ${saved.amount}${saved.currency} (${saved.event_date})`);
			}catch(e){ alert('OCR解析失败：'+(e?.message||e)); }
		};
		input.click();
	});
	// 文本描述
	btns[2].addEventListener('click',async()=>{
		const desc=prompt('请描述账单（例：上周五打车 36 元，交通）');
		if(!desc) return;
		try{
			const {saved} = await parseAndStoreBill(desc,'text');
			alert(`已保存：${saved.category} ${saved.amount}${saved.currency} (${saved.event_date})`);
		}catch(e){ alert('解析失败：'+(e?.message||e)); }
	});
})();
</script>

<!-- 底部导航栏 -->
<nav class="fixed bottom-0 left-0 right-0 z-10 mx-auto max-w-lg border-t border-slate-200/50 bg-background-light/90 backdrop-blur-sm">
  <div class="flex h-16 justify-around">
    <a class="flex flex-1 flex-col items-center justify-center gap-1 text-slate-500/70 hover:text-primary" href="../welcome/code.html">
      <span class="material-symbols-outlined">dashboard</span>
      <span class="text-xs font-medium">首页</span>
    </a>
    <a class="flex flex-1 flex-col items-center justify-center gap-1 text-slate-500/70 hover:text-primary" href="../transaction_list/code.html">
      <span class="material-symbols-outlined">receipt_long</span>
      <span class="text-xs font-medium">账单</span>
    </a>
    <a class="flex flex-1 flex-col items-center justify-center gap-1 text-slate-500/70 hover:text-primary" href="../financial_advice/code.html">
      <span class="material-symbols-outlined">auto_awesome</span>
      <span class="text-xs font-medium">建议</span>
    </a>
    <a class="flex flex-1 flex-col items-center justify-center gap-1 text-slate-500/70 hover:text-primary" href="../visualization/code.html">
      <span class="material-symbols-outlined">pie_chart</span>
      <span class="text-xs font-medium">图表</span>
    </a>
    <a class="flex flex-1 flex-col items-center justify-center gap-1 text-slate-500/70 hover:text-primary" href="../settings/code.html">
      <span class="material-symbols-outlined">person</span>
      <span class="text-xs font-medium">我的</span>
    </a>
  </div>
</nav>
</body></html>